<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´—è¡£æ©Ÿå³æ™‚ç‹€æ…‹ç›£æ§</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        #machine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .machine-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .card-header h2 {
            margin: 0;
            font-size: 1.2em;
        }
        .status {
            font-size: 1.5em;
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-top: 10px;
        }
        .status-text { display: block; }
        .time-left { display: block; font-size: 0.8em; margin-top: 5px; color: #555; }
        .status.loading { background-color: #e0e0e0; color: #555; }
        .status.available { background-color: #d4edda; color: #155724; }
        .status.in-use { background-color: #f8d7da; color: #721c24; }
        .status.offline { background-color: #fff3cd; color: #856404; }

        /* --- æ‚¨æä¾›çš„éˆ´éº CSS --- */
        .container {
            --color: #a5a5b0;
            --size: 25px; /* èª¿æ•´å¤§å°ä»¥é©æ‡‰å¡ç‰‡ */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            font-size: var(--size);
            user-select: none;
            fill: var(--color);
        }
        .container .bell-regular, .container .bell-solid {
            position: absolute;
            animation: keyframes-fill .5s;
        }
        .container .bell-solid { display: none; }
        .container input:checked ~ .bell-regular { display: none; }
        .container input:checked ~ .bell-solid { display: block; }
        .container input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        @keyframes keyframes-fill {
            0% { opacity: 0; }
            25% { transform: rotate(25deg); }
            50% { transform: rotate(-20deg) scale(1.2); }
            75% { transform: rotate(15deg); }
        }
    </style>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>

    <h1>æ¸…å¤§ä»é½‹æ´—è¡£æ©Ÿç‹€æ…‹</h1>
    <div id="machine-grid"></div>

    <script>
        // åœ¨æ©Ÿå™¨è³‡æ–™ä¸­å¢åŠ  notificationEnabled å±¬æ€§ä¾†è¿½è¹¤é€šçŸ¥ç‹€æ…‹
        const machines = [
            { name: 'ä»é½‹ç”·çƒ˜1', mac: '94c96001b2ca', element: null, status: 'é€£ç·šä¸­...', timeLeft: 0, notificationEnabled: false },
            { name: 'ä»é½‹ç”·çƒ˜2', mac: '94c96001b3cb', element: null, status: 'é€£ç·šä¸­...', timeLeft: 0, notificationEnabled: false },
            { name: 'ä»é½‹ç”·æ´—1', mac: '94c96001b3e3', element: null, status: 'é€£ç·šä¸­...', timeLeft: 0, notificationEnabled: false },
            { name: 'ä»é½‹ç”·æ´—2', mac: '94c96001b3f4', element: null, status: 'é€£ç·šä¸­...', timeLeft: 0, notificationEnabled: false },
            { name: 'ä»é½‹ç”·æ´—3', mac: '94c96001b3f6', element: null, status: 'é€£ç·šä¸­...', timeLeft: 0, notificationEnabled: false },
            { name: 'ä»é½‹ç”·æ´—4', mac: '94c96001b3f5', element: null, status: 'é€£ç·šä¸­...', timeLeft: 0, notificationEnabled: false },
        ];

        const grid = document.getElementById('machine-grid');

        // åˆå§‹åŒ–é é¢å¡ç‰‡ï¼Œä¸¦åŠ å…¥éˆ´éºæŒ‰éˆ•
        machines.forEach(machine => {
            const card = document.createElement('div');
            card.className = 'machine-card';
            card.id = `machine-${machine.mac}`;
            card.innerHTML = `
                <div class="card-header">
                    <h2>${machine.name}</h2>
                    <label class="container">
                        <input type="checkbox">
                        <svg class="bell-regular" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><path d="M224 0c-17.7 0-32 14.3-32 32V49.9C119.5 61.4 64 124.2 64 200v33.4c0 45.4-15.5 89.5-43.8 124.9L5.3 377c-5.8 7.2-6.9 17.1-2.9 25.4S14.8 416 24 416H424c9.2 0 17.6-5.3 21.6-13.6s2.9-18.2-2.9-25.4l-14.9-18.6C399.5 322.9 384 278.8 384 233.4V200c0-75.8-55.5-138.6-128-150.1V32c0-17.7-14.3-32-32-32zm0 96h8c57.4 0 104 46.6 104 104v33.4c0 47.9 13.9 94.6 39.7 134.6H72.3C98.1 328 112 281.3 112 233.4V200c0-57.4 46.6-104 104-104h8zm64 352H224 160c0 17 6.7 33.3 18.7 45.3s28.3 18.7 45.3 18.7s33.3-6.7 45.3-18.7s18.7-28.3 18.7-45.3z"/></svg>
                        <svg class="bell-solid" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><path d="M224 0c-17.7 0-32 14.3-32 32V51.2C119 66 64 130.6 64 208v18.8c0 47-17.3 92.4-48.5 127.6l-7.4 8.3c-8.4 9.4-10.4 22.9-5.3 34.4S19.4 416 32 416H416c12.6 0 24-7.4 29.2-18.9s3.1-25-5.3-34.4l-7.4-8.3C401.3 319.2 384 273.9 384 226.8V208c0-77.4-55-142-128-156.8V32c0-17.7-14.3-32-32-32zm45.3 493.3c12-12 18.7-28.3 18.7-45.3H224 160c0 17 6.7 33.3 18.7 45.3s28.3 18.7 45.3 18.7s33.3-6.7 45.3-18.7z"/></svg>
                    </label>
                </div>
                <div class="status loading">
                    <span class="status-text">é€£ç·šä¸­...</span>
                    <span class="time-left"></span>
                </div>
            `;
            grid.appendChild(card);
            machine.element = card;

            // ç‚ºæ¯å€‹éˆ´éºæŒ‰éˆ•æ·»åŠ é»æ“Šäº‹ä»¶
            const notificationCheckbox = card.querySelector('input[type="checkbox"]');
            notificationCheckbox.addEventListener('change', (event) => {
                handleNotificationToggle(machine, event.target.checked);
            });
        });

        // è™•ç†éˆ´éºé»æ“Šçš„å‡½æ•¸
        function handleNotificationToggle(machine, isEnabled) {
            // æª¢æŸ¥æ©Ÿå™¨æ˜¯å¦æ­£åœ¨é‹è½‰ä¸­
            if (isEnabled && !machine.status.includes('é‹è½‰ä¸­')) {
                alert(`${machine.name} ç›®å‰æ˜¯é–’ç½®ç‹€æ…‹ï¼Œç„¡éœ€è¨­å®šé€šçŸ¥ã€‚`);
                machine.element.querySelector('input[type="checkbox"]').checked = false;
                return;
            }

            // æª¢æŸ¥ä¸¦è«‹æ±‚é€šçŸ¥æ¬Šé™
            if (Notification.permission === 'granted') {
                machine.notificationEnabled = isEnabled;
                console.log(`${machine.name} é€šçŸ¥å·² ${isEnabled ? 'é–‹å•Ÿ' : 'é—œé–‰'}`);
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        machine.notificationEnabled = isEnabled;
                        console.log(`${machine.name} é€šçŸ¥å·² ${isEnabled ? 'é–‹å•Ÿ' : 'é—œé–‰'}`);
                    } else {
                        // å¦‚æœä½¿ç”¨è€…æ‹’çµ•ï¼Œå‰‡å°‡ checkbox å½ˆå›
                        machine.element.querySelector('input[type="checkbox"]').checked = false;
                    }
                });
            } else {
                // å¦‚æœæ¬Šé™å·²è¢«æ‹’çµ•
                alert('æ‚¨å·²å°é–æ­¤ç¶²ç«™çš„é€šçŸ¥ï¼Œè«‹è‡³ç€è¦½å™¨è¨­å®šä¸­é‡æ–°é–‹å•Ÿã€‚');
                machine.element.querySelector('input[type="checkbox"]').checked = false;
            }
        }

        // ç™¼é€æ¡Œé¢é€šçŸ¥çš„å‡½æ•¸
        function sendNotification(machine) {
            if (Notification.permission !== 'granted') return;

            const title = 'æ´—è¡£æ©Ÿå¥½äº†ï¼ğŸ‘•';
            const options = {
                body: `${machine.name} å·²å®Œæˆé‹è½‰ï¼Œå¯ä»¥å»å–è¡£ç‰©å›‰ï¼`,
                // æ‚¨å¯ä»¥æ›æˆè‡ªå·±çš„åœ–ç¤º URL
                icon: 'https://cdn-icons-png.flaticon.com/512/3094/3094916.png' 
            };
            new Notification(title, options);
        }

        // --- MQTT é€£ç·šèˆ‡è¨Šæ¯è™•ç† (èˆ‡å…ˆå‰ç‰ˆæœ¬é¡ä¼¼ï¼Œä½†å¢åŠ äº†ç‹€æ…‹è®ŠåŒ–ç›£è½) ---
        const brokerUrl = 'wss://wipepay.com.tw:443/mqtt/';
        const client = mqtt.connect(brokerUrl);

        client.on('connect', () => {
            machines.forEach(machine => {
                client.subscribe(`machine/${machine.mac}/status/`);
            });
        });

        client.on('message', (topic, payload) => {
            const mac = topic.split('/')[1];
            const data = JSON.parse(payload.toString());
            const machine = machines.find(m => m.mac === mac);
            if (!machine || data.type !== 'status') return;

            const oldStatus = machine.status; // ä¿å­˜èˆŠç‹€æ…‹
            let newStatus = 'æœªçŸ¥';

            if ([256, 3072, 3200, 8192].includes(data.status)) {
                newStatus = 'é–’ç½®/å®Œæˆ';
                machine.timeLeft = 0;
            } else if ([2048, 2176, 4096].includes(data.status)) {
                newStatus = 'é‹è½‰ä¸­';
                const elapsedSeconds = (Date.now() / 1000) - data.ts;
                machine.timeLeft = Math.max(0, Math.floor(data.timeLeft - elapsedSeconds));
            } else {
                newStatus = `ç­‰å¾…æ“ä½œ (${data.status})`;
                machine.timeLeft = 0;
            }
            machine.status = newStatus;

            // **æ ¸å¿ƒï¼šæª¢æŸ¥ç‹€æ…‹è®ŠåŒ–ä¸¦è§¸ç™¼é€šçŸ¥**
            if (machine.notificationEnabled && oldStatus.includes('é‹è½‰ä¸­') && newStatus.includes('é–’ç½®/å®Œæˆ')) {
                sendNotification(machine);
                // ç™¼é€å¾Œè‡ªå‹•é—œé–‰é€šçŸ¥ä¸¦å–æ¶ˆå‹¾é¸
                machine.notificationEnabled = false;
                machine.element.querySelector('input[type="checkbox"]').checked = false;
            }

            updateMachineDisplay(machine);
        });
        
        // --- å€’æ•¸è¨ˆæ™‚èˆ‡ç•«é¢æ›´æ–° ---
        setInterval(() => {
            machines.forEach(machine => {
                if (machine.timeLeft > 0) {
                    machine.timeLeft -= 1;
                    if (machine.timeLeft === 0 && machine.status.includes('é‹è½‰ä¸­')) {
                         // ç•¶æœ¬åœ°è¨ˆæ™‚å™¨æ­¸é›¶æ™‚ï¼Œä¹Ÿè§¸ç™¼æª¢æŸ¥
                         const oldStatus = machine.status;
                         machine.status = 'é–’ç½®/å®Œæˆ';
                         if (machine.notificationEnabled) {
                             sendNotification(machine);
                             machine.notificationEnabled = false;
                             machine.element.querySelector('input[type="checkbox"]').checked = false;
                         }
                    }
                    updateMachineDisplay(machine);
                }
            });
        }, 1000);

        function updateMachineDisplay(machine) {
            // ... (ç•«é¢æ›´æ–°é‚è¼¯èˆ‡å‰ä¸€ç‰ˆç›¸åŒ) ...
            const statusDiv = machine.element.querySelector('.status');
            const statusTextSpan = machine.element.querySelector('.status-text');
            const timeLeftSpan = machine.element.querySelector('.time-left');
            statusTextSpan.textContent = machine.status;
            if (machine.timeLeft > 0) {
                 const minutes = Math.floor(machine.timeLeft / 60);
                 const seconds = machine.timeLeft % 60;
                 timeLeftSpan.textContent = `å‰©é¤˜æ™‚é–“: ${minutes}åˆ† ${seconds.toString().padStart(2, '0')}ç§’`;
            } else {
                 timeLeftSpan.textContent = '';
            }
            statusDiv.className = 'status';
            if (machine.status.includes('é‹è½‰ä¸­')) statusDiv.classList.add('in-use');
            else if (machine.status.includes('é–’ç½®') || machine.status.includes('å®Œæˆ')) statusDiv.classList.add('available');
            else if (machine.status.includes('é›¢ç·š')) statusDiv.classList.add('offline');
            else statusDiv.classList.add('loading');
        }
    </script>

</body>
</html>

